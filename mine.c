#include <string.h>
#include <stdint.h>

// strstr with rabin karp + buzhash seems pretty fast
// much simpler code than musl or glibc
// generated executable is 100-500b larger than musl
char *my_strstr(const char *h, const char *n) {
  uint32_t buztable[256] = {  // head -c 1k /dev/urandom | od -An -tx4 -w32
    0x22dfde65, 0x08028e37, 0xfa2e954a, 0xa301c56d, 0x14bf00db, 0x933e4b8a, 0xdcfc2b05, 0xd17f2f19,
    0xcd052337, 0xdd939e4a, 0x5a4abeab, 0xdfcd075e, 0xbcfb84f9, 0x087a1f06, 0x523859e6, 0xe3af7d30,
    0xe4cd0b3a, 0x614e279e, 0x6545761b, 0x517f5dbb, 0x2b983d31, 0x50a5c85f, 0x1325ec6c, 0x67364943,
    0xa9b2123c, 0x773a6f0c, 0x87cd5192, 0xa8db3a4c, 0x27b681b5, 0x6ed74c20, 0xec93b31d, 0x4ccf189e,
    0xd357ddfc, 0x5787094c, 0x2223cfa2, 0x2e0e3467, 0x09ba1f05, 0x294fdad6, 0x61615e7e, 0x3d642370,
    0x749d7ad7, 0x844ca280, 0x9cbf6a1d, 0x825b8f5e, 0x7e5539a3, 0xbfb7bab1, 0x42dfc800, 0xbb68de85,
    0x9898f1df, 0xe25528b8, 0xdd29bc34, 0x3b078de4, 0xa671db26, 0x203750eb, 0x79e39bf9, 0xa4934aa1,
    0xffadaf1e, 0xebe92954, 0xaa42db56, 0x3dd5f8d0, 0x01039f37, 0xb7407642, 0xc970f564, 0xfe2e5795,
    0x62abc938, 0x13ffed40, 0x86983b16, 0xd36c70e6, 0x926035e6, 0xfcb40e3b, 0x442da21c, 0x75e6ad86,
    0xc386f6fb, 0x76047661, 0xd5152bb3, 0x280af496, 0xdc8fc11e, 0x80f04782, 0x00b1cc1d, 0x86c8a457,
    0x357af94f, 0x5f37d066, 0xada81731, 0x11880ca4, 0x837334a8, 0x788cd6e5, 0xde25f337, 0x661e3b44,
    0xfc76a97e, 0xc93c2e50, 0x6610e2db, 0xcc52571e, 0x42ade19c, 0x58f46933, 0xdfad654c, 0x5e565d37,
    0xd3b10883, 0x3b9d9535, 0xdbe7dfad, 0x5ad6297e, 0x91268de3, 0x94dcd8c1, 0x167dc922, 0x4ddce847,
    0x485b8365, 0xa696c99a, 0xdcdbf845, 0xebd8ecb3, 0x3729ef76, 0xfe45914c, 0x70c85c6c, 0xa74f6aa7,
    0xccfd3a51, 0x7e5381e6, 0x0297b6bd, 0xfce1b8c7, 0xce13129d, 0xa322269c, 0x3f2f273d, 0x6e4c4c61,
    0x4cdb6519, 0xa0ae9d04, 0x0177f848, 0x1ed64a83, 0x87060dbb, 0x7b2c84c0, 0x69912df6, 0x9403a58a,
    0xf83b7096, 0x996d5dc3, 0x027be146, 0x824d861e, 0x15aaafdc, 0xf07eb968, 0x78596c98, 0xc74282d9,
    0x945a8860, 0x03480eb6, 0xa4ded11e, 0x00876070, 0x890ab498, 0xbcddcaaa, 0x677d2af0, 0x326439e0,
    0xfdfa4d9d, 0xc48fbd00, 0xf6194d2c, 0x9118ac42, 0x8ea9c2a3, 0xf985012d, 0x3f200af9, 0x09b69cad,
    0x0576b16a, 0x87d7f728, 0x1ebf072d, 0xd06c3c80, 0xda74d1a4, 0x71753cc8, 0xea5f529f, 0xbca164c7,
    0x88d07b87, 0xda3761ec, 0xf40b2cff, 0xf8bbcd25, 0x59ef316b, 0x53efc3fa, 0xd9fa3a0e, 0xdb17fca7,
    0x8ce7ecd6, 0x11e859be, 0x8855ad64, 0xfd7a4b4a, 0x8de451bf, 0x2b1f181e, 0xc47cbb63, 0x23ae5630,
    0x319a3a94, 0x60e20bd6, 0xe46d8dfe, 0x08dc58f2, 0xc44e4efe, 0x3d727c91, 0xe58805d6, 0x97202d60,
    0x83912930, 0x4e78066c, 0xadb0e47c, 0x7c9242d5, 0x4497e694, 0x3b1416da, 0xdf5743c6, 0x8f5c229d,
    0x5dc8f605, 0x3c131d0d, 0x337793ba, 0x66b0eb2d, 0xd132d218, 0x50dd229e, 0x67b2078e, 0xfb9892a8,
    0x4687884c, 0xd899d026, 0xb467a923, 0x3265a171, 0x0c7387d5, 0xc359f849, 0xaf10ab6b, 0x082a169f,
    0x0cb0953a, 0xa3db035f, 0x9795eada, 0x59920a24, 0x5a233942, 0x4248214b, 0xe32943d0, 0x584ee97f,
    0x6501ce47, 0x154f093d, 0xd5782b21, 0x8dfbce6b, 0x18c086d8, 0xaf242e51, 0x0a53ae86, 0x151ce41f,
    0x4c410bc9, 0xaa3da04b, 0x613872e4, 0xdc57111d, 0x24dbe807, 0xebca45a3, 0x16ab5659, 0xb4a261ab,
    0x640c011d, 0xd2784504, 0x03b5ac3d, 0x8e6685d3, 0x3016aa6c, 0xb297c7a0, 0x57cdb0df, 0x4dddfbcf,
    0x24253ecd, 0x4233df4b, 0x4af310ff, 0x08b80b62, 0xa9be2ae9, 0x82ab7b1c, 0x8a855649, 0x68d902b6,
    0x0d1749e1, 0xb7a8a188, 0xbc4abb7e, 0x2979075a, 0xd9b553d3, 0xc74be394, 0xfd6b1ad2, 0x2efb9d22,
  };
  // never computes strlen(h)
  if (!n[0]) return (char *)h;
  h = strchr(h, *n);
  if (!h || !n[1]) return (char *)h;

  uint8_t same = 1;
  uint32_t nhash = 0, hhash = 0;
  size_t i;
  // hash the needle, set nl = strlen(n) and check if strncmp(h, n, nl) == 0
  for (i = 0; n[i] && h[i]; i++) {
    nhash ^= buztable[(unsigned char)n[i]];
    hhash ^= buztable[(unsigned char)h[i]];
    if (n[i] != h[i]) same = 0;
  }
  if (!h[i] && !n[i]) return same ? (char *)h : NULL;
  if (!h[i]) return NULL;
  size_t nl = i;

  for ( ; h[i]; i++) {
    hhash ^= buztable[(unsigned char)h[i]];
    hhash ^= buztable[(unsigned char)h[i-nl]];
    if (nhash == hhash && !strncmp(h+i+1-nl, n, nl)) return (char *)h+i+1-nl;
  }

  return NULL;
}
